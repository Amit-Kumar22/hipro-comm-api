# Comprehensive Image Upload and Display Fix - PowerShell Script\n# Run this script to deploy and test all image-related fixes\n\nWrite-Host \"üöÄ Deploying Comprehensive Image Upload and Display Fixes...\" -ForegroundColor Green\nWrite-Host \"\" \n\n# Step 1: Show current directory and verify files\nWrite-Host \"üìÅ Current directory: $(Get-Location)\" -ForegroundColor Cyan\nWrite-Host \"üìÑ Checking fix files...\" -ForegroundColor Cyan\n\n$FilesToCheck = @(\n    \"src/controllers/imageController.ts\",\n    \"src/routes/upload.ts\",\n    \"src/routes/images.ts\", \n    \"src/models/Image.ts\",\n    \"src/services/uploadService.ts\",\n    \"test-image-serving-cjs.js\",\n    \"fix-product-images-comprehensive.js\",\n    \"IMAGE_SERVING_FIX.md\"\n)\n\nforeach ($File in $FilesToCheck) {\n    if (Test-Path $File) {\n        Write-Host \"‚úÖ $File\" -ForegroundColor Green\n    } else {\n        Write-Host \"‚ùå Missing: $File\" -ForegroundColor Red\n    }\n}\n\n# Check frontend files\nWrite-Host \"\\nüåê Checking frontend fixes...\" -ForegroundColor Cyan\n$FrontendFiles = @(\n    \"../hipro-comm/components/ui/ProductCard.tsx\",\n    \"../hipro-comm/lib/image-enhanced.ts\",\n    \"../hipro-comm-admin/components/ui/ImageUpload.tsx\"\n)\n\nforeach ($File in $FrontendFiles) {\n    if (Test-Path $File) {\n        Write-Host \"‚úÖ $File\" -ForegroundColor Green\n    } else {\n        Write-Host \"‚ùå Missing: $File\" -ForegroundColor Red\n    }\n}\n\n# Step 2: Check Node.js\nWrite-Host \"\\nüì¶ Checking Node.js...\" -ForegroundColor Cyan\ntry {\n    $nodeVersion = node --version\n    Write-Host \"‚úÖ Node.js version: $nodeVersion\" -ForegroundColor Green\n} catch {\n    Write-Host \"‚ùå Node.js not found\" -ForegroundColor Red\n    return\n}\n\n# Step 3: Test database connection and image serving\nWrite-Host \"\\nüîç Testing image serving...\" -ForegroundColor Cyan\nif (Test-Path \"test-image-serving-cjs.js\") {\n    try {\n        node \"test-image-serving-cjs.js\"\n        Write-Host \"‚úÖ Image serving test completed\" -ForegroundColor Green\n    } catch {\n        Write-Host \"‚ùå Image serving test failed\" -ForegroundColor Red\n    }\n} else {\n    Write-Host \"‚ùå test-image-serving-cjs.js not found\" -ForegroundColor Red\n}\n\n# Step 4: Fix existing product images\nWrite-Host \"\\nüîß Fixing existing product image URLs...\" -ForegroundColor Cyan\n$fixImages = Read-Host \"Do you want to fix existing product image URLs? This will remove broken blob/data URLs (y/N)\"\nif ($fixImages -match \"^[Yy]$\") {\n    if (Test-Path \"fix-product-images-comprehensive.js\") {\n        try {\n            Write-Host \"üîß Running comprehensive image fix...\" -ForegroundColor Yellow\n            node \"fix-product-images-comprehensive.js\"\n            Write-Host \"‚úÖ Product image fix completed\" -ForegroundColor Green\n        } catch {\n            Write-Host \"‚ùå Product image fix failed\" -ForegroundColor Red\n        }\n    } else {\n        Write-Host \"‚ùå fix-product-images-comprehensive.js not found\" -ForegroundColor Red\n    }\n}\n\n# Step 5: Environment check\nWrite-Host \"\\nüåç Environment Configuration:\" -ForegroundColor Cyan\nWrite-Host \"   NODE_ENV: $($env:NODE_ENV ?? 'not set')\" -ForegroundColor White\nWrite-Host \"   API_BASE_URL: $($env:API_BASE_URL ?? 'not set')\" -ForegroundColor White\nWrite-Host \"   NEXT_PUBLIC_API_URL: $($env:NEXT_PUBLIC_API_URL ?? 'not set')\" -ForegroundColor White\nWrite-Host \"   MONGODB_URI: $($env:MONGODB_URI ?? 'not set')\" -ForegroundColor White\n\n# Step 6: Build projects  \nWrite-Host \"\\nüî® Building projects...\" -ForegroundColor Cyan\n$buildProjects = Read-Host \"Do you want to build all projects (API, Frontend, Admin)? (y/N)\"\nif ($buildProjects -match \"^[Yy]$\") {\n    # Build API\n    Write-Host \"\\nüîß Building API...\" -ForegroundColor Yellow\n    try {\n        if (Test-Path \"package.json\") {\n            npm run build\n            Write-Host \"‚úÖ API build completed\" -ForegroundColor Green\n        } else {\n            Write-Host \"‚ö†Ô∏è No package.json found in current directory\" -ForegroundColor Yellow\n        }\n    } catch {\n        Write-Host \"‚ùå API build failed\" -ForegroundColor Red\n    }\n    \n    # Build Frontend\n    Write-Host \"\\nüîß Building Frontend...\" -ForegroundColor Yellow\n    Push-Location\n    try {\n        if (Test-Path \"../hipro-comm\") {\n            Set-Location \"../hipro-comm\"\n            npm run build\n            Write-Host \"‚úÖ Frontend build completed\" -ForegroundColor Green\n        }\n    } catch {\n        Write-Host \"‚ùå Frontend build failed\" -ForegroundColor Red\n    } finally {\n        Pop-Location\n    }\n    \n    # Build Admin Panel\n    Write-Host \"\\nüîß Building Admin Panel...\" -ForegroundColor Yellow\n    Push-Location\n    try {\n        if (Test-Path \"../hipro-comm-admin\") {\n            Set-Location \"../hipro-comm-admin\"\n            npm run build\n            Write-Host \"‚úÖ Admin Panel build completed\" -ForegroundColor Green\n        }\n    } catch {\n        Write-Host \"‚ùå Admin Panel build failed\" -ForegroundColor Red\n    } finally {\n        Pop-Location\n    }\n}\n\n# Step 7: Service restart prompt\nWrite-Host \"\\nüîÑ Service Management\" -ForegroundColor Cyan\nWrite-Host \"For production deployment, restart the following services:\" -ForegroundColor White\nWrite-Host \"   ‚Ä¢ API Server (Node.js/PM2)\" -ForegroundColor White\nWrite-Host \"   ‚Ä¢ Frontend (Next.js)\" -ForegroundColor White\nWrite-Host \"   ‚Ä¢ Admin Panel (Next.js)\" -ForegroundColor White\nWrite-Host \"   ‚Ä¢ Web Server (Nginx/Apache)\" -ForegroundColor White\n\n# Step 8: Testing instructions\nWrite-Host \"\\nüß™ Manual Testing Checklist:\" -ForegroundColor Yellow\nWrite-Host \"\\n1. üì§ Test Image Upload in Admin Panel:\" -ForegroundColor White\nWrite-Host \"   ‚Ä¢ Go to admin panel ‚Üí Products ‚Üí Add New Product\" -ForegroundColor Gray\nWrite-Host \"   ‚Ä¢ Upload various image formats (JPG, PNG, SVG)\" -ForegroundColor Gray\nWrite-Host \"   ‚Ä¢ Verify no blob URLs in browser console\" -ForegroundColor Gray\nWrite-Host \"   ‚Ä¢ Check that upload errors show proper messages\" -ForegroundColor Gray\n\nWrite-Host \"\\n2. üíæ Test Product Creation:\" -ForegroundColor White\nWrite-Host \"   ‚Ä¢ Create a new product with uploaded images\" -ForegroundColor Gray\nWrite-Host \"   ‚Ä¢ Verify product saves successfully\" -ForegroundColor Gray\nWrite-Host \"   ‚Ä¢ Check that all images are included in product data\" -ForegroundColor Gray\n\nWrite-Host \"\\n3. üåê Test Customer Website Display:\" -ForegroundColor White\nWrite-Host \"   ‚Ä¢ Visit customer website (shop.hiprotech.org)\" -ForegroundColor Gray\nWrite-Host \"   ‚Ä¢ Check product listings show images\" -ForegroundColor Gray\nWrite-Host \"   ‚Ä¢ Verify product detail pages display images\" -ForegroundColor Gray\nWrite-Host \"   ‚Ä¢ Test image loading on slow connections\" -ForegroundColor Gray\n\nWrite-Host \"\\n4. üîç Test Error Handling:\" -ForegroundColor White\nWrite-Host \"   ‚Ä¢ Check browser developer console for errors\" -ForegroundColor Gray\nWrite-Host \"   ‚Ä¢ Verify placeholder images show for missing images\" -ForegroundColor Gray\nWrite-Host \"   ‚Ä¢ Test with disabled network to check fallbacks\" -ForegroundColor Gray\n\nWrite-Host \"\\n5. üåç Test Cross-Environment:\" -ForegroundColor White\nWrite-Host \"   ‚Ä¢ Test on different devices and browsers\" -ForegroundColor Gray\nWrite-Host \"   ‚Ä¢ Verify images work in incognito/private mode\" -ForegroundColor Gray\nWrite-Host \"   ‚Ä¢ Check mobile responsiveness\" -ForegroundColor Gray\n\n# Step 9: Troubleshooting info\nWrite-Host \"\\nüõ†Ô∏è Troubleshooting:\" -ForegroundColor Yellow\nWrite-Host \"\\nIf images still don't display:\" -ForegroundColor White\nWrite-Host \"   1. Check server logs for image serving errors\" -ForegroundColor Gray\nWrite-Host \"   2. Verify CORS headers: curl -H 'Origin: https://shop.hiprotech.org' -I 'https://shop.hiprotech.org/api/v1/images/{imageId}'\" -ForegroundColor Gray\nWrite-Host \"   3. Test image URLs directly in browser\" -ForegroundColor Gray\nWrite-Host \"   4. Check database for blob/data URLs: run fix-product-images-comprehensive.js\" -ForegroundColor Gray\nWrite-Host \"   5. Verify environment variables are set correctly\" -ForegroundColor Gray\n\nWrite-Host \"\\nüìö Documentation: IMAGE_SERVING_FIX.md\" -ForegroundColor Cyan\nWrite-Host \"\\n‚úÖ Comprehensive image fix deployment completed!\" -ForegroundColor Green\nWrite-Host \"\\nüéØ Next: Test the upload and display flow manually\" -ForegroundColor Yellow\n